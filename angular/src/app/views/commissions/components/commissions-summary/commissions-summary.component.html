<!-- Filters -->
<div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
  <div class="md:grid md:grid-cols-3 md:gap-6">
    <div class="md:col-span-1">
      <h3 class="text-lg font-medium leading-6 text-gray-900">
        Filter Settings
      </h3>
      <p class="mt-1 text-sm leading-5 text-gray-500">
        Sales commissions can be viewed per year, quarter, week, month or single
        dates.
      </p>
    </div>
    <div class="mt-5 md:mt-0 md:col-span-2">
      <form (ngSubmit)="submit()" [formGroup]="filterForm" id="filterForm">
        <div class="grid grid-cols-6 gap-6">
          <div class="col-span-6 sm:col-span-3">
            <label
              class="block text-sm font-medium leading-5 text-gray-700"
              for="filter"
              >Filter</label
            >
            <ng-select
              [(ngModel)]="filterOption"
              (ngModelChange)="resetPeriodFiltersForm()"
              [bindLabel]="'value'"
              [bindValue]="'key'"
              [clearable]="false"
              [items]="filters"
              [ngModelOptions]="{ standalone: true }"
              class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
              id="filter">
            </ng-select>
          </div>

          <div
            *ngIf="userRole !== salesPersonRole"
            class="col-span-6 sm:col-span-3">
            <label
              class="block text-sm font-medium leading-5 text-gray-700"
              for="sales_person"
              >Sales Person</label
            >

            <ng-select
              (change)="customerChanged($event)"
              [(ngModel)]="selectedSales"
              [ngModelOptions]="{ standalone: true }"
              [bindLabel]="'name'"
              [items]="salesSelect$ | async"
              [loading]="isSalesLoading"
              [typeahead]="salesInput$"
              class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
              id="sales_person">
            </ng-select>
          </div>

          <input formControlName="sp_name" id="sp_name" type="hidden" />

          <input
            formControlName="sales_person_id"
            id="sales_person_id"
            type="hidden" />

          <div
            [ngClass]="
              filterOption === 'date' ? 'sm:col-span-2' : 'sm:col-span-3'
            "
            class="col-span-6">
            <label
              class="block text-sm font-medium leading-5 text-gray-700"
              for="year"
              >Year</label
            >
            <ng-select
              [clearable]="false"
              [items]="years"
              class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
              formControlName="year"
              id="year">
            </ng-select>
          </div>

          <ng-container [ngSwitch]="filterOption">
            <ng-container *ngSwitchCase="'date'">
              <div [@filterAnimation] class="col-span-6 sm:col-span-2">
                <label
                  class="block text-sm font-medium leading-5 text-gray-700"
                  for="month"
                  >Month</label
                >
                <ng-select
                  (change)="monthChanged($event)"
                  [bindLabel]="'value'"
                  [bindValue]="'key'"
                  [clearable]="false"
                  [items]="months"
                  class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
                  formControlName="month"
                  id="month">
                </ng-select>
              </div>

              <div [@filterAnimation] class="col-span-6 sm:col-span-2">
                <label
                  class="block text-sm font-medium leading-5 text-gray-700"
                  for="day"
                  >Day</label
                >
                <ng-select
                  [clearable]="false"
                  [items]="days"
                  [readonly]="
                    filterForm.controls.month.value ? undefined : true
                  "
                  class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
                  formControlName="day"
                  id="day">
                </ng-select>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'week'">
              <div [@filterAnimation] class="col-span-6 sm:col-span-3">
                <label
                  class="block text-sm font-medium leading-5 text-gray-700"
                  for="week"
                  >Week</label
                >
                <ng-select
                  [clearable]="false"
                  [items]="weeks"
                  class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
                  formControlName="week"
                  id="week">
                </ng-select>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'month'">
              <div [@filterAnimation] class="col-span-3">
                <label
                  class="block text-sm font-medium leading-5 text-gray-700"
                  for="month-solo"
                  >Month</label
                >
                <ng-select
                  [bindLabel]="'value'"
                  [bindValue]="'key'"
                  [clearable]="false"
                  [items]="months"
                  class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
                  formControlName="month"
                  id="month-solo">
                </ng-select>
              </div>
            </ng-container>

            <ng-container *ngSwitchCase="'quarter'">
              <div [@filterAnimation] class="col-span-6 sm:col-span-3">
                <label
                  class="block text-sm font-medium leading-5 text-gray-700"
                  for="quarter"
                  >Quarter</label
                >
                <ng-select
                  [clearable]="false"
                  [items]="quarters"
                  class="mt-1 block form-select custom w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:shadow-outline-blue focus:border-blue-300 transition duration-150 ease-in-out sm:text-sm sm:leading-5"
                  formControlName="quarter"
                  id="quarter">
                </ng-select>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </form>
    </div>
  </div>

  <div class="flex justify-end pt-3 text-right">
    <span class="h-10 mr-2 flex w-full md:w-auto rounded-md shadow-sm">
      <button
        (click)="resetFilters()"
        class="w-full h-10 md:w-auto inline-flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-gray-400 hover:bg-gray-500 focus:outline-none focus:border-gray-500 focus:shadow-outline-indigo active:bg-gray-500 transition duration-150 ease-in-out"
        type="button">
        Reset filters
      </button>
    </span>
    <span class="w-full md:w-auto flex rounded-md shadow-sm">
      <button
        class="w-full h-10 md:w-auto inline-flex justify-center py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white bg-indigo-600 focus:outline-none focus:border-indigo-700 focus:shadow-outline-indigo active:bg-indigo-700 transition duration-150 ease-in-out"
        form="filterForm"
        type="submit"
        [class.opacity-50]="filterForm?.invalid"
        [class.cursor-not-allowed]="filterForm?.invalid"
        [class.hover:bg-indigo-500]="filterForm?.valid">
        Save
      </button>
    </span>
  </div>
</div>

<!-- Summary table -->
<div class="mt-6 bg-white overflow-hidden shadow rounded-lg">
  <div class="bg-white px-4 py-5 border-b border-gray-200 sm:px-6">
    <div
      class="-ml-4 -mt-2 flex items-center justify-between flex-wrap sm:flex-no-wrap">
      <div class="ml-4 mt-2">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Commission Overview {{ displayName ? '- ' + displayName : '' }}
        </h3>
      </div>

      <div *ngIf="commissionSummary?.companies.length" class="ml-4 mt-2">
        <h3 class="text-base leading-6 font-medium text-gray-900">
          Base commission: {{ commissionSummary?.base_commission }}%
        </h3>
      </div>

      <div *ngIf="commissionSummary?.companies.length" class="ml-4 mt-2">
        <h3 class="text-base leading-6 font-medium text-gray-900">
          Total commissions: {{ commissionSummary?.count_company_commissions }}
        </h3>
      </div>

      <div
        class="ml-4 mt-2 flex-shrink-0 table-btns"
        *ngIf="isAllowedForOperations">
        <span
          class="tooltip-element inline-block rounded-full shadow-sm table-btn">
          <button
            (click)="addSalesCommission()"
            class="action-btn"
            type="button">
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                clip-rule="evenodd"
                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                fill-rule="evenodd"></path>
            </svg>
          </button>
          <span class="tooltip"> Add </span>
        </span>
      </div>
    </div>
  </div>

  <div class="relative px-4 py-5 sm:p-6">
    <div *ngIf="isLoading" class="loading-overlay">
      <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
    </div>

    <div
      *ngIf="commissionSummary?.companies.length; else noData"
      class="flex flex-col">
      <div class="-my-2 py-2 overflow-x-auto sm:-mx-6 sm:px-6 lg:-mx-8 lg:px-8">
        <div
          class="align-middle inline-block min-w-full shadow overflow-hidden sm:rounded-lg border-b border-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <!-- Headers -->
            <thead>
              <tr>
                <th colspan="4">Name</th>
                <th colspan="1">
                  <div class="pl-3">COMMISSION</div>
                </th>
              </tr>
            </thead>

            <!-- Companies -->
            <tbody *ngFor="let company of commissionSummary?.companies">
              <tr>
                <td colspan="5">
                  {{ company.name }}
                </td>
              </tr>

              <!-- Customers -->
              <ng-container *ngFor="let customer of company.customers">
                <tr>
                  <!--class="border-b-2 border-gray-50"-->
                  <td colspan="5">
                    <div class="pl-3 flex">
                      <span
                        (click)="customer.expanded = !customer.expanded"
                        class="cursor-pointer">
                        <ng-container *ngIf="customer.expanded; else expand">
                          <svg
                            class="w-5 h-5"
                            fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                              clip-rule="evenodd"
                              d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                              fill-rule="evenodd"></path>
                          </svg>
                        </ng-container>
                        <ng-template #expand>
                          <svg
                            class="w-5 h-5"
                            fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                              clip-rule="evenodd"
                              d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                              fill-rule="evenodd"></path>
                          </svg>
                        </ng-template>
                      </span>
                      <span>{{ customer.name }}</span>
                    </div>
                  </td>
                </tr>

                <!-- Items -->
                <ng-container *ngIf="customer?.quotes.length > 0">
                  <ng-container *ngIf="customer.expanded">
                    <tr [@collapseAnimation] class="font-extrabold">
                      <td></td>
                      <td class="item">
                        <div class="pl-3">Invoice number</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Order number</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Total Revenue</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Total Invoiced</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Gross margin %</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Commission percentage %</div>
                      </td>
                      <td
                        class="item"
                        *ngIf="!filterForm.controls.sales_person_id.value">
                        <div class="pl-3">Sales Person</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Commission</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Commission Paid</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Status</div>
                      </td>
                      <td class="item">
                        <div class="pl-3">Paid At</div>
                      </td>
                    </tr>

                    <ng-container *ngFor="let quote of customer.quotes">
                      <ng-container *ngFor="let invoice of quote.invoices">
                        <ng-container
                          *ngFor="
                            let commission of invoice.commissions;
                            let even = even
                          ">
                          <tr [@collapseAnimation] [ngClass]="{ odd: even }">
                            <td class="relative">
                              <div *ngIf="isAllowedForOperations">
                                <div class="flex justify-end items-center">
                                  <button
                                    (click)="
                                      commission.showActions =
                                        !commission.showActions
                                    "
                                    aria-expanded="true"
                                    aria-haspopup="true"
                                    aria-label="Options"
                                    class="flex items-center focus:outline-none"
                                    id="options-menu"
                                    type="button">
                                    <svg
                                      class="h-5 w-5"
                                      fill="currentColor"
                                      viewBox="0 0 20 20">
                                      <path
                                        d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                    </svg>
                                  </button>
                                </div>
                                <div
                                  *ngIf="commission.showActions"
                                  [@menuAnimation]
                                  [clickOutsideEnabled]="
                                    !!commission.showActions
                                  "
                                  [delayClickOutsideInit]="true"
                                  (click)="commission.showActions = false"
                                  (clickOutside)="
                                    commission.showActions = false
                                  "
                                  class="top-10 left-0 origin-top-left absolute mt-2 mb-1 mr-6 w-auto rounded-md shadow-lg z-40">
                                  <div class="rounded-md bg-white shadow-xs">
                                    <div
                                      aria-labelledby="options-menu"
                                      aria-orientation="vertical"
                                      class="py-1"
                                      role="menu">
                                      <a
                                        (click)="
                                          editSalesCommission(
                                            invoice,
                                            commission
                                          )
                                        "
                                        class="cursor-pointer group flex items-center px-4 py-2 text-sm leading-5 text-gray-700 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:bg-gray-100 focus:text-gray-900"
                                        role="menuitem">
                                        <svg
                                          class="mr-3 h-5 w-5 text-gray-400 group-hover:text-gray-500 group-focus:text-gray-500"
                                          fill="currentColor"
                                          viewBox="0 0 20 20">
                                          <path
                                            d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                          <path
                                            clip-rule="evenodd"
                                            d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                            fill-rule="evenodd" />
                                        </svg>
                                        Edit sales commission
                                      </a>
                                      <a
                                        (click)="
                                          unpayIndividualSalesComission(
                                            invoice,
                                            commission
                                          )
                                        "
                                        *ngIf="
                                          commission.paid_value ==
                                          commission.commission
                                        "
                                        class="cursor-pointer group flex items-center px-4 py-2 text-sm leading-5 text-gray-700 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:bg-gray-100 focus:text-gray-900"
                                        role="menuitem">
                                        <svg
                                          fill="currentColor"
                                          viewBox="0 0 20 20"
                                          class="mr-3 h-5 w-5 text-gray-400 group-hover:text-gray-500 group-focus:text-gray-500">
                                          <path
                                            d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                                          <path
                                            clip-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"
                                            fill-rule="evenodd"></path>
                                        </svg>
                                        Mark sales commission as Unpaid
                                      </a>
                                      <a
                                        (click)="
                                          payIndividualSalesComission(
                                            invoice,
                                            commission
                                          )
                                        "
                                        *ngIf="
                                          commission.paid_value !=
                                          commission.commission
                                        "
                                        class="cursor-pointer group flex items-center px-4 py-2 text-sm leading-5 text-gray-700 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:bg-gray-100 focus:text-gray-900"
                                        role="menuitem">
                                        <svg
                                          fill="currentColor"
                                          viewBox="0 0 20 20"
                                          class="mr-3 h-5 w-5 text-gray-400 group-hover:text-gray-500 group-focus:text-gray-500">
                                          <path
                                            d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                                          <path
                                            clip-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z"
                                            fill-rule="evenodd"></path>
                                        </svg>
                                        Pay sales commission
                                      </a>
                                      <a
                                        (click)="
                                          deleteSalesCommission(
                                            invoice,
                                            commission
                                          )
                                        "
                                        class="cursor-pointer group flex items-center px-4 py-2 text-sm leading-5 text-gray-700 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:bg-gray-100 focus:text-gray-900"
                                        role="menuitem">
                                        <svg
                                          class="mr-3 h-5 w-5 text-gray-400 group-hover:text-gray-500 group-focus:text-gray-500"
                                          fill="currentColor"
                                          viewBox="0 0 20 20">
                                          <path
                                            clip-rule="evenodd"
                                            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                            fill-rule="evenodd"></path>
                                        </svg>
                                        Delete sales commission
                                      </a>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                <a
                                  [routerLink]="[
                                    '/' +
                                      company.id +
                                      '/projects/' +
                                      invoice.project_id +
                                      '/invoices/' +
                                      invoice.id +
                                      '/edit'
                                  ]"
                                  target="_blank"
                                  class="text-indigo-500 hover:text-indigo-400 focus:outline-none">
                                  {{ invoice.number }}
                                </a>
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                <a
                                  [routerLink]="[
                                    '/' +
                                      company.id +
                                      '/projects/' +
                                      invoice.project_id +
                                      '/orders/' +
                                      invoice.order_id +
                                      '/edit'
                                  ]"
                                  target="_blank"
                                  class="text-indigo-500 hover:text-indigo-400 focus:outline-none">
                                  {{ invoice.order }}
                                </a>
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{
                                  commission.total
                                    | currency
                                      : (currency | enumValue: 'currencycode')
                                }}
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{
                                  commission.total_price
                                    | currency
                                      : (currency | enumValue: 'currencycode')
                                }}
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{ commission.gross_margin }}%
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{ commission.commission_percentage }}%
                              </div>
                            </td>
                            <td
                              class="item"
                              *ngIf="
                                !filterForm.controls.sales_person_id.value
                              ">
                              <div class="pl-3">
                                {{ commission.sales_person }}
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{
                                  commission.commission
                                    | currency
                                      : (currency | enumValue: 'currencycode')
                                }}
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{
                                  commission.paid_value
                                    | currency
                                      : (currency | enumValue: 'currencycode')
                                }}
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{ commission.status }}
                              </div>
                            </td>
                            <td class="item">
                              <div class="pl-3">
                                {{
                                  commission.paid_at
                                    ? (commission.paid_at
                                      | momentDate: dateFormats.Date)
                                    : '-'
                                }}
                              </div>
                            </td>
                          </tr>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </ng-container>

                <tr class="font-extrabold">
                  <td colspan="4">
                    <div class="pl-6">Total {{ customer.name }}</div>
                  </td>
                  <td colspan="1">
                    <div class="pl-3">
                      {{
                        customer?.total_customer_commission
                          | currency: (currency | enumValue: 'currencycode')
                      }}
                    </div>
                  </td>
                </tr>
              </ng-container>

              <tr class="font-extrabold">
                <td colspan="4">
                  <div class="pl-0">Total company commission</div>
                </td>
                <td colspan="1">
                  <div class="pl-3">
                    {{
                      company?.total_company_commission
                        | currency: (currency | enumValue: 'currencycode')
                    }}
                  </div>
                </td>
              </tr>
            </tbody>

            <!-- Total all companies commission -->
            <tbody *ngIf="commissionSummary?.total_all_companies_commission">
              <tr class="font-black">
                <td colspan="4">
                  <div>
                    <h3
                      class="lg:text-base font-medium leading-6 text-gray-900">
                      Total
                    </h3>
                  </div>
                </td>
                <td colspan="1">
                  <div class="pl-3">
                    <h3
                      class="lg:text-base font-medium leading-6 text-gray-900">
                      {{
                        commissionSummary?.total_all_companies_commission
                          | currency: (currency | enumValue: 'currencycode')
                      }}
                    </h3>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <ng-template #noData>
      <ng-container>
        <div class="pl-6">
          <span>No data for this filter settings!</span>
        </div>
      </ng-container>
    </ng-template>
  </div>
</div>

<!-- Payment Logs table -->
<div
  class="mt-6 bg-white overflow-hidden shadow rounded-lg"
  *ngIf="totalOpenAmount?.total_commission_amount > 0">
  <div class="bg-white px-4 py-5 border-b border-gray-200 sm:px-6">
    <div
      class="-ml-4 flex items-center justify-between flex-wrap sm:flex-no-wrap">
      <div class="ml-4 flex justify-between">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Payment Logs {{ displayName ? '- ' + displayName : '' }}
        </h3>
      </div>
      <ng-container *ngIf="totalOpenAmount?.total_commission_amount > 0">
        <h3 class="text-base leading-6 font-medium text-gray-900">
          Total Open Commission:
          {{
            totalOpenAmount?.total_commission_amount
              | currency: (currency | enumValue: 'currencycode')
          }}
        </h3>
      </ng-container>
    </div>
  </div>

  <div class="relative px-4 py-5 sm:p-6">
    <div *ngIf="isLoading" class="loading-overlay">
      <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
    </div>

    <div
      *ngIf="paymentLogs?.data.length; else empty"
      class="bg-white overflow-x-auto shadow rounded-lg">
      <table class="min-w-full mb-5">
        <thead>
          <tr>
            <th
              *ngIf="true"
              class="px-6 py-3 text-right border-b border-gray-200 bg-gray-50">
              <div class="flex items-center justify-end">
                <!--...-->
              </div>
            </th>
            <th
              class="text-center px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
              COMMISSION PAID
            </th>

            <th
              class="text-center px-6 py-3 border-b border-gray-200 bg-gray-50 text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
              STATUS
            </th>

            <th
              class="text-center px-6 py-3 border-b border-gray-200 bg-gray-50 text-xs leading-4 font-medium text-gray-500 uppercase tracking-wider">
              PAID AT
            </th>
          </tr>
        </thead>

        <!-- Item body  -->
        <ng-container *ngIf="paymentLogs?.data.length > 0">
          <tbody
            *ngFor="
              let item of paymentLogs.data;
              let even = odd;
              let i = index
            ">
            <!-- Item row -->
            <tr [ngClass]="{ odd: even }">
              <!-- Actions column -->
              <td
                class="px-6 py-4 whitespace-no-wrap text-right text-sm leading-5 text-gray-500 font-medium">
                <div class="relative inline-block text-left">
                  <div>
                    <button
                      (click)="item.showActions = !item.showActions"
                      [class.cursor-not-allowed]="
                        item.status !== statusPaid ||
                        userRole !== salesPersonRole
                      "
                      [class.opacity-50]="
                        item.status !== statusPaid ||
                        userRole !== salesPersonRole
                      "
                      aria-expanded="true"
                      aria-haspopup="true"
                      aria-label="Options"
                      class="flex items-center focus:outline-none"
                      id="options-menu"
                      type="button">
                      <svg
                        class="h-5 w-5"
                        fill="currentColor"
                        viewBox="0 0 20 20">
                        <path
                          d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                      </svg>
                    </button>
                  </div>

                  <!--
                         Dropdown panel, show/hide based on dropdown state.

                         Entering: "transition ease-out duration-100"
                           From: "transform opacity-0 scale-95"
                           To: "transform opacity-100 scale-100"
                         Leaving: "transition ease-in duration-75"
                           From: "transform opacity-100 scale-100"
                           To: "transform opacity-0 scale-95"
                       -->
                </div>

                <!--can be moved inside top div-->
                <div
                  *ngIf="
                    item.showActions &&
                    item.status === statusPaid &&
                    userRole === salesPersonRole
                  "
                  [@menuAnimation]
                  [clickOutsideEnabled]="!!item.showActions"
                  [delayClickOutsideInit]="true"
                  (clickOutside)="item.showActions = false"
                  class="origin-top-right absolute left-6 mt-2 rounded-md shadow-lg z-50">
                  <div class="rounded-md bg-white shadow-xs">
                    <div
                      aria-labelledby="options-menu"
                      aria-orientation="vertical"
                      class="py-2"
                      role="menu">
                      <button
                        (click)="confirm(i, item); item.showActions = false"
                        class="group w-full flex items-center px-4 py-2 text-sm leading-5 text-gray-700 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:bg-gray-100 focus:text-gray-900"
                        role="menuitem"
                        type="button">
                        <svg
                          class="w-5 h-5"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                          xmlns="http://www.w3.org/2000/svg">
                          <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                          <path
                            clip-rule="evenodd"
                            d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            fill-rule="evenodd"></path>
                        </svg>

                        <span class="ml-2">Confirm payment</span>
                      </button>
                    </div>
                  </div>
                </div>
              </td>

              <td
                class="px-6 py-4 text-left whitespace-no-wrap text-sm leading-5 text-gray-500">
                {{
                  item?.amount
                    | currency: (currency | enumValue: 'currencycode')
                }}
              </td>

              <td
                class="px-6 py-4 text-left whitespace-no-wrap text-sm leading-5 text-gray-500">
                {{ item?.status | enumValue: 'commissionpaymentlogstatus' }}
              </td>

              <td
                class="px-6 py-4 text-left whitespace-no-wrap text-sm leading-5 text-gray-500">
                {{
                  item.paid_at
                    ? (item.paid_at | momentDate: dateFormats.Date)
                    : '-'
                }}
              </td>
            </tr>
          </tbody>
        </ng-container>
      </table>
    </div>

    <ng-template #empty>
      <ng-container>
        <div class="pl-6">
          <span>No payment logs!</span>
        </div>
      </ng-container>
    </ng-template>
  </div>
</div>

<oz-finance-pay-commission-modal #payCommissionModal [currency]="currency">
</oz-finance-pay-commission-modal>
<oz-finance-pay-individual-commission-modal
  #payIndividualCommissionModal
  [currency]="currency">
</oz-finance-pay-individual-commission-modal>
<oz-finance-confirm-modal #confirmModal></oz-finance-confirm-modal>
<oz-finance-edit-sales-commission-modal
  #editSalesCommissionModal
  [commissionSettings]="
    commissionSettings
  "></oz-finance-edit-sales-commission-modal>
<oz-finance-add-sales-commission-modal
  #addSalesCommissionModal
  [commissionSummary]="commissionSummary"
  [commissionSettings]="commissionSettings">
</oz-finance-add-sales-commission-modal>
